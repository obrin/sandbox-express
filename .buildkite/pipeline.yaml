env:
  KUBE_CONTEXT: nuc
  APP: sandbox-express
  TAG: ${BUILDKITE_COMMIT}
  IMAGE: ${APP}:${TAG}
steps:
  - label: ':docker: Build & Push'
    command: pack build ${IMAGE} --builder gcr.io/buildpacks/builder:v1 && docker push ${IMAGE}

  - wait

  - label: ':rocket: Deploy'
    command: helm dependency update charts && helm upgrade --install --kube-context ${KUBE_CONTEXT} --set image.tag=${TAG} --create-namespace --namespace ${APP} ${APP} charts/ 
